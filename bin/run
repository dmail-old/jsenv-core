#!/usr/bin/env node

var commandAPI = require('../lib/command-api/index.js');

function startCommand(params) {
    require('../index.js');

    global.setup().then(function(engine) {
        engine.debug('start with params', params);

        function stripTrailingSep(pathname) {
            if (pathname[pathname.length - 1] === '/') {
                pathname = pathname.slice(0, -1);
            }
            return pathname;
        }

        function urlIsSiblingOrDescendantOf(url, otherUrl) {
            url = new global.URL(url, otherUrl);
            otherUrl = new global.URL(otherUrl);

            if (url.protocol !== otherUrl.protocol) {
                return false;
            }
            if (url.host !== otherUrl.host) {
                return false;
            }
            if (url.port !== otherUrl.port) {
                return false;
            }

            var pathname = stripTrailingSep(url.pathname);
            var potentialParentOrSibling = stripTrailingSep(otherUrl.pathname);
            var potentialDirname = potentialParentOrSibling.slice(0, potentialParentOrSibling.lastIndexOf('/'));

            return pathname.startsWith(potentialDirname);
        }

        if (params.test) {
            engine.config(function() {
                engine.test(engine.mainLocation);
            });
        }
        if (params.cover) {
            engine.config(function() {
                var options = {
                    urlIsPartOfCoverage: function(url) {
                        // the url must be a sibling or a descendant of engine.mainLocation
                        return urlIsSiblingOrDescendantOf(url, engine.mainLocation);
                    }
                };

                // most time we do code coverage test to see how a file is covering all it's dependencies
                // so checking that the file is the mainLocation or a peer or inside is sufficient
                return engine.coverage.install(options);
            });

            engine.run(function() {
                var mainLocation = engine.mainLocation;
                var options = {
                    directory: engine.locateFrom('error-coverage', mainLocation, true),
                    reportConsole: true
                };

                return engine.coverage.collect(engine.coverage.value).then(function(collector) {
                    return engine.coverage.report(collector, options);
                });
            });
        }

        engine.importMain(params[0]);
    });
}

function versionCommand() {
    var path = require('path');
    var packagePath = path.resolve(__dirname, '../package.json');
    var packageMeta = require(packagePath);
    console.log(packageMeta.version);
}

var commandSignatures = {
    0: {
        type: 'string',
        params: {
            cover: {
                type: 'boolean',
                default: false,
                params: {
                    output: {
                        type: 'array',
                        enum: ['console', 'json'],
                        default: ['console']
                    }
                }
            },
            test: {
                type: 'boolean',
                default: false,
                params: {
                    output: {
                        type: 'array',
                        enum: ['console', 'json'],
                        default: ['console']
                    }
                }
            }
        },
        fn: startCommand
    },
    version: {
        type: 'boolean',
        default: false,
        fn: versionCommand
    },
    usage: {
        fn: function() {
            console.log('system-run <path>');
        }
    }
};

var commandApi = commandAPI(commandSignatures);
commandApi.exec(process.argv.slice(2));
